#!/usr/bin/env sh

echo "üé® Formateando c√≥digo con Laravel Pint..."

# Verificar si Docker est√° corriendo
if ! docker-compose ps 2>/dev/null | grep -q "Up"; then
    echo "‚ö†Ô∏è  Advertencia: Contenedores no est√°n corriendo"
    echo "   Ejecuta: make up"
    echo "   Saltando formateo..."
    exit 0
fi

# Obtener archivos PHP staged
FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.php$' || true)

if [ -z "$FILES" ]; then
    echo "‚úÖ No hay archivos PHP para formatear"
    exit 0
fi

echo "üìù Archivos a formatear:"
echo "$FILES" | sed 's/^/  - /'

# Verificar que vendor/bin/pint existe
if ! docker-compose exec -T app test -f ./vendor/bin/pint; then
    echo "‚ö†Ô∏è  Advertencia: Laravel Pint no encontrado"
    echo "   Ejecuta: make shell && composer install"
    echo "   Saltando formateo..."
    exit 0
fi

# Formatear con Pint dentro del contenedor
docker-compose exec -T app ./vendor/bin/pint $FILES

# Si Pint modific√≥ archivos, agregarlos al commit
if [ $? -eq 0 ]; then
    echo "$FILES" | xargs git add
    echo "‚úÖ C√≥digo formateado correctamente"
else
    echo "‚ùå Error al formatear c√≥digo"
    exit 1
fi

exit 0